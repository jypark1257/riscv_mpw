# RISC-V GCC Compilers
# riscv64-linux-gnu-gcc - Compiler from system packages (for local dev)
# riscv64-unknown-elf-gcc - From SiFive (on c125m/eda machines)

RISCV_DEFAULT := riscv64-unknown-elf

LIB_PATH := ../rv_lib
LIB_SOURCES := $(wildcard ../rv_lib/*.c)
CSRCS := $(wildcard *.c)
SSRCS := $(wildcard *.s)

LDSRC := ../linker_script.ld

GCC_OPTS += -mabi=ilp32 -march=rv32imc -static -mstrict-align -mcmodel=medany -nostartfiles -T $(LDSRC)

# Set default target dependencies based on FPGA flag
ifeq ($(FPGA), true)
	DEFAULT_DEPS := $(TARGET).hex split-mem
else
	DEFAULT_DEPS := $(TARGET).hex
endif

default: $(DEFAULT_DEPS)

SOURCES = $(CSRCS) $(SSRCS) ../startup.s
ifeq ($(INCLUDE_LIB), true)
	SOURCES += $(LIB_SOURCES)
endif

# objdump is called before strip because it inlines functions and makes the assembly harder to read
$(TARGET).elf: $(SOURCES)
	$(RISCV_DEFAULT)-gcc $(GCC_OPTS) -I$(LIB_PATH) $^ -o $@
	$(RISCV_DEFAULT)-objdump -D -Mnumeric $@ > $(basename $@).dump
	$(RISCV_DEFAULT)-strip -R .comment -R .note.gnu.build-id $@
	$(RISCV_DEFAULT)-objcopy $(basename $@).elf -O binary $(basename $@).bin
	$(RISCV_DEFAULT)-bin2hex -w 32 $(basename $@).bin $(basename $@).hex
	# sed -i '1i @0' $(basename $@).hex
# cp $(basename $@).hex ../../rtl/mem.hex

$(TARGET).hex: $(TARGET).elf

# Memory splitting target
split-mem: $(TARGET).hex
	@echo "Generating memory files (.mem)..."
	@if [ -f "../split_bios_fpga.py" ]; then \
		python3 ../split_bios_fpga.py $(TARGET).hex; \
		echo "Memory files generated successfully!"; \
	else \
		echo "Warning: split_bios_fpga.py not found"; \
	fi

clean:
	rm -f *.elf *.dump *.hex *.bin *.mem

.PHONY: clean default split-mem